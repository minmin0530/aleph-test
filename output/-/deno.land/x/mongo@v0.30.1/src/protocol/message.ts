import{OpCode as w,setHeader as p}from"/-/deno.land/x/mongo@v0.30.1/src/protocol/header.ts?v=l7tvw53z";import{deserialize as c,serialize as g}from"/-/deno.land/x/mongo@v0.30.1/deps.ts?v=l7tvw53z";var y=new TextEncoder,m=new TextDecoder;function I(i){let n=0,r=i.map(o=>{if("document"in o){let t=g(o.document),e=new Uint8Array(1+t.byteLength);return new DataView(e.buffer).setUint8(0,0),e.set(t,1),n+=e.byteLength,e}{let t=y.encode(o.identifier+"\0"),e=0,f=o.documents.map(u=>{let a=g(u);return e+=a.byteLength,a}),s=new Uint8Array(5+t.byteLength+e),l=new DataView(s.buffer);l.setUint8(0,1),l.setUint32(1,s.byteLength-1,!0);let d=4;for(let u of f)s.set(u,d),d+=u.byteLength;return n+=s.byteLength,s}});return{length:n,sections:r}}function T(i){var n;let{length:r,sections:o}=I(i.sections),t=new Uint8Array(20+r),e=new DataView(t.buffer);p(e,{messageLength:t.byteLength,responseTo:i.responseTo,requestId:i.requestId,opCode:w.MSG}),e.setInt32(16,(n=i.flags)!=null?n:0,!0);let f=20;for(let s of o)t.set(s,f),f+=s.byteLength;return t}function q(i,n){let r=new DataView(n.buffer),o=r.getInt32(0),t=[],e=4;for(;e<r.byteLength;){let f=r.getInt8(e);if(e++,f===0){let s=r.getInt32(e,!0),l=c(new Uint8Array(r.buffer.slice(e,e+s)));e+=s,t.push({document:l})}else if(f===1){let s=r.getInt32(e,!0),l=new Uint8Array(r.buffer.slice(e+4,e+s-4)),d=l.findIndex(b=>b===0),u=m.decode(n.slice(0,d)),a=l.slice(d+1),h=L(a);e+=s,t.push({identifier:u,documents:h})}else throw Error("Invalid section kind: "+f)}return{responseTo:i.responseTo,requestId:i.requestId,flags:o,sections:t}}function L(i){let n=0,r=[],o=new DataView(i);for(;n<i.byteLength;){let t=o.getInt32(n,!0),e=c(i.slice(n,n+t));r.push(e),n+=t}return r}export{q as deserializeMessage,T as serializeMessage};

import{Binary as c}from"/-/deno.land/x/web_bson@v0.2.3/src/binary.ts?v=l7tvw53z";import{Code as g}from"/-/deno.land/x/web_bson@v0.2.3/src/code.ts?v=l7tvw53z";import{DBRef as u,isDBRefLike as T}from"/-/deno.land/x/web_bson@v0.2.3/src/db_ref.ts?v=l7tvw53z";import{Decimal128 as w}from"/-/deno.land/x/web_bson@v0.2.3/src/decimal128.ts?v=l7tvw53z";import{Double as b}from"/-/deno.land/x/web_bson@v0.2.3/src/double.ts?v=l7tvw53z";import{BSONError as y,BSONTypeError as j}from"/-/deno.land/x/web_bson@v0.2.3/src/error.ts?v=l7tvw53z";import{Int32 as $}from"/-/deno.land/x/web_bson@v0.2.3/src/int_32.ts?v=l7tvw53z";import{Long as p}from"/-/deno.land/x/web_bson@v0.2.3/src/long.ts?v=l7tvw53z";import{MaxKey as h}from"/-/deno.land/x/web_bson@v0.2.3/src/max_key.ts?v=l7tvw53z";import{MinKey as S}from"/-/deno.land/x/web_bson@v0.2.3/src/min_key.ts?v=l7tvw53z";import{ObjectId as d}from"/-/deno.land/x/web_bson@v0.2.3/src/objectid.ts?v=l7tvw53z";import{isObjectLike as J}from"/-/deno.land/x/web_bson@v0.2.3/src/parser/utils.ts?v=l7tvw53z";import{BSONRegExp as m}from"/-/deno.land/x/web_bson@v0.2.3/src/regexp.ts?v=l7tvw53z";import{BSONSymbol as N}from"/-/deno.land/x/web_bson@v0.2.3/src/symbol.ts?v=l7tvw53z";import{Timestamp as a}from"/-/deno.land/x/web_bson@v0.2.3/src/timestamp.ts?v=l7tvw53z";function v(e){return J(e)&&Reflect.has(e,"_bsontype")&&typeof e._bsontype=="string"}var _={$oid:d,$binary:c,$uuid:c,$symbol:N,$numberInt:$,$numberDecimal:w,$numberDouble:b,$numberLong:p,$minKey:S,$maxKey:h,$regex:m,$regularExpression:m,$timestamp:a};function D(e,n={}){if(typeof e=="number"){if(n.relaxed||n.legacy)return e;if(Math.floor(e)===e){if(e>=-2147483648&&e<=2147483647)return new $(e);if(e>=-9223372036854776e3&&e<=9223372036854776e3)return p.fromNumber(e)}return new b(e)}if(e==null||typeof e!="object")return e;if(e.$undefined)return null;let r=Object.keys(e).filter(t=>t.startsWith("$")&&e[t]!=null);for(let t=0;t<r.length;t++){let o=_[r[t]];if(o)return o.fromExtendedJSON(e,n)}if(e.$date!=null){let t=e.$date,o=new Date;return n.legacy?typeof t=="number"?o.setTime(t):typeof t=="string"&&o.setTime(Date.parse(t)):typeof t=="string"?o.setTime(Date.parse(t)):p.isLong(t)?o.setTime(t.toNumber()):typeof t=="number"&&n.relaxed&&o.setTime(t),o}if(e.$code!=null){let t=Object.assign({},e);return e.$scope&&(t.$scope=D(e.$scope)),g.fromExtendedJSON(e)}if(T(e)||e.$dbPointer){let t=e.$ref?e:e.$dbPointer;if(t instanceof u)return t;let o=Object.keys(t).filter(l=>l.startsWith("$")),i=!0;if(o.forEach(l=>{["$ref","$id","$db"].indexOf(l)===-1&&(i=!1)}),i)return u.fromExtendedJSON(t)}return e}function I(e,n){return e.map((r,t)=>{n.seenObjects.push({propertyName:`index ${t}`,obj:null});try{return f(r,n)}finally{n.seenObjects.pop()}})}function x(e){let n=e.toISOString();return e.getUTCMilliseconds()!==0?n:n.slice(0,-5)+"Z"}function f(e,n){if((typeof e=="object"||typeof e=="function")&&e!==null){let r=n.seenObjects.findIndex(t=>t.obj===e);if(r!==-1){let t=n.seenObjects.map(s=>s.propertyName),o=t.slice(0,r).map(s=>`${s} -> `).join(""),i=t[r],l=" -> "+t.slice(r+1,t.length-1).map(s=>`${s} -> `).join(""),O=t[t.length-1],B=" ".repeat(o.length+i.length/2),E="-".repeat(l.length+(i.length+O.length)/2-1);throw new j(`Converting circular structure to EJSON:
    ${o}${i}${l}${O}
    ${B}\\${E}/`)}n.seenObjects[n.seenObjects.length-1].obj=e}if(Array.isArray(e))return I(e,n);if(e===void 0)return null;if(e instanceof Date){let r=e.getTime(),t=r>-1&&r<2534023188e5;return n.legacy?n.relaxed&&t?{$date:e.getTime()}:{$date:x(e)}:n.relaxed&&t?{$date:x(e)}:{$date:{$numberLong:e.getTime().toString()}}}if(typeof e=="number"&&(!n.relaxed||!isFinite(e))){if(Math.floor(e)===e){let r=e>=-2147483648&&e<=2147483647,t=e>=-9223372036854776e3&&e<=9223372036854776e3;if(r)return{$numberInt:e.toString()};if(t)return{$numberLong:e.toString()}}return{$numberDouble:e.toString()}}if(e instanceof RegExp){let r=e.flags;if(r===void 0){let o=e.toString().match(/[gimuy]*$/);o&&(r=o[0])}return new m(e.source,r).toExtendedJSON(n)}return e!=null&&typeof e=="object"?L(e,n):e}var k={Binary:e=>new c(e.buffer,e.subType),Code:e=>new g(e.code,e.scope),DBRef:e=>new u(e.collection,e.oid,e.db,e.fields),Decimal128:e=>new w(e.bytes),Double:e=>new b(e.value),Int32:e=>new $(e.value),Long:e=>p.fromBits(e.low!=null?e.low:e.low_,e.low!=null?e.high:e.high_,e.low!=null?e.unsigned:e.unsigned_),MaxKey:()=>new h,MinKey:()=>new S,ObjectId:e=>new d(e),ObjectID:e=>new d(e),BSONRegExp:e=>new m(e.pattern,e.options),Symbol:e=>new N(e.value),Timestamp:e=>a.fromBits(e.low,e.high)};function L(e,n){if(e==null||typeof e!="object")throw new y("not an object instance");let r=e._bsontype;if(r===void 0){let t={};for(let o in e){n.seenObjects.push({propertyName:o,obj:null});try{t[o]=f(e[o],n)}finally{n.seenObjects.pop()}}return t}if(v(e)){let t=e;if(typeof t.toExtendedJSON!="function"){let o=k[e._bsontype];if(!o)throw new j("Unrecognized or invalid _bsontype: "+e._bsontype);t=o(t)}return r==="Code"&&t.scope?t=new g(t.code,f(t.scope,n)):r==="DBRef"&&t.oid&&(t=new u(f(t.collection,n),f(t.oid,n),f(t.db,n),f(t.fields,n))),t.toExtendedJSON(n)}throw new y("_bsontype must be a string, but was: "+typeof r)}function R(e,n){let r=Object.assign({},{relaxed:!0,legacy:!1},n);return typeof r.relaxed=="boolean"&&(r.strict=!r.relaxed),typeof r.strict=="boolean"&&(r.relaxed=!r.strict),JSON.parse(e,(t,o)=>{if(t.indexOf("\0")!==-1)throw new y(`BSON Document field names cannot contain null bytes, found: ${JSON.stringify(t)}`);return D(o,r)})}function M(e,n,r,t){r!=null&&typeof r=="object"&&(t=r,r=0),n==null||typeof n!="object"||Array.isArray(n)||(t=n,n=void 0,r=0);let o=Object.assign({relaxed:!0,legacy:!1},t,{seenObjects:[{propertyName:"(root)",obj:null}]}),i=f(e,o);return JSON.stringify(i,n,r)}function Y(e,n){return JSON.parse(M(e,n=n||{}))}function ee(e,n){return n=n||{},R(JSON.stringify(e),n)}export{ee as deserialize,v as isBSONType,R as parse,Y as serialize,M as stringify};

import{BufReader as y,deferred as g,writeAll as _}from"/-/deno.land/x/mongo@v0.30.1/deps.ts?v=l7tvw53z";import{MongoDriverError as m,MongoServerError as j}from"/-/deno.land/x/mongo@v0.30.1/src/error.ts?v=l7tvw53z";import{handshake as O}from"/-/deno.land/x/mongo@v0.30.1/src/protocol/handshake.ts?v=l7tvw53z";import{parseHeader as P}from"/-/deno.land/x/mongo@v0.30.1/src/protocol/header.ts?v=l7tvw53z";import{deserializeMessage as I,serializeMessage as q}from"/-/deno.land/x/mongo@v0.30.1/src/protocol/message.ts?v=l7tvw53z";function e(c,t){if(!Object.prototype.hasOwnProperty.call(c,t))throw new TypeError("attempted to use private field on non-instance");return c[t]}var v=0;function h(c){return"__private_"+v+++"_"+c}var M=0,n=h("_socket"),o=h("_isPendingResponse"),a=h("_isPendingRequest"),i=h("_pendingResponses"),d=h("_reader"),l=h("_commandQueue"),b=class{async connect(){let{connectionId:t}=await O(this)}async commandSingle(t,s){let[r]=await this.command(t,s);if(r.ok===0)throw new j(r);return r}async command(t,s){let r=M++;e(this,l)[l].push({requestId:r,db:t,body:s}),this.send();let u=g();e(this,i)[i].set(r,u),this.receive();let p=await u,f=[];for(let w of p==null?void 0:p.sections)"document"in w?f.push(w.document):f=f.concat(w.documents);return f}async send(){if(!e(this,a)[a]){for(e(this,a)[a]=!0;e(this,l)[l].length>0;){let t=e(this,l)[l].shift(),s=q({requestId:t.requestId,responseTo:0,sections:[{document:{...t.body,$db:t.db}}]});await _(e(this,n)[n],s)}e(this,a)[a]=!1}}async receive(){if(!e(this,o)[o]){for(e(this,o)[o]=!0;e(this,i)[i].size>0;){let t=await e(this,d)[d].readFull(new Uint8Array(16));if(!t)throw new m("Invalid response header");let s=P(t),r=await e(this,d)[d].readFull(new Uint8Array(s.messageLength-16));if(!r)throw new m("Invalid response body");let u=I(s,r),p=e(this,i)[i].get(s.responseTo);e(this,i)[i].delete(s.responseTo),p==null||p.resolve(u)}e(this,o)[o]=!1}}constructor(t){Object.defineProperty(this,n,{writable:!0,value:void 0}),Object.defineProperty(this,o,{writable:!0,value:!1}),Object.defineProperty(this,a,{writable:!0,value:!1}),Object.defineProperty(this,i,{writable:!0,value:new Map}),Object.defineProperty(this,d,{writable:!0,value:void 0}),Object.defineProperty(this,l,{writable:!0,value:[]}),e(this,n)[n]=t,e(this,d)[d]=new y(e(this,n)[n])}};export{b as WireProtocol};
